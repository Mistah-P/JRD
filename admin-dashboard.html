<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - JRD Fire Safety</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .admin-dashboard {
            min-height: 100vh;
            background: #f8f9fa;
            padding-top: 80px;
        }

        .admin-header {
            background: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        .admin-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .admin-logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: #e74c3c;
        }

        .admin-logo i {
            margin-right: 10px;
        }

        .admin-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 20px;
        }

        .dashboard-title {
            font-size: 2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 2rem;
        }

        .upload-section {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .upload-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1.5rem;
        }

        .upload-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            align-items: start;
        }

        .form-column {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #e74c3c;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
        }

        .file-upload-label:hover {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        .file-upload-label.dragover {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        .upload-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            grid-column: 1 / -1;
            justify-self: start;
        }

        .upload-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .gallery-management {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .gallery-admin-item {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .gallery-admin-item:hover {
            transform: translateY(-5px);
        }

        .gallery-admin-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .gallery-item-info {
            padding: 1rem;
        }

        .gallery-item-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .gallery-item-location {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .gallery-item-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .gallery-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .edit-btn, .delete-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: #3498db;
            color: white;
        }

        .edit-btn:hover {
            background: #2980b9;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .message.success {
            background: #f0fff4;
            color: #38a169;
            border: 1px solid #9ae6b4;
        }

        .message.error {
            background: #fee;
            color: #c53030;
            border: 1px solid #feb2b2;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .section-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #eee;
        }
        
        .tab-btn {
            padding: 1rem 2rem;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            color: #e74c3c;
            border-bottom-color: #e74c3c;
        }
        
        .tab-btn:hover {
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .upload-form {
                grid-template-columns: 1fr;
            }
            
            .gallery-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="admin-dashboard">
        <header class="admin-header">
            <nav class="admin-nav">
                <div class="admin-logo">
                    <i class="fas fa-fire-extinguisher"></i>
                    <span>JRD Fire Safety - Admin</span>
                </div>
                <div class="admin-actions">
                    <a href="index.html" class="btn btn-secondary">View Website</a>
                    <button class="logout-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </nav>
        </header>

        <div class="dashboard-container">
            <h1 class="dashboard-title">Gallery Management Dashboard</h1>
            
            <div class="message" id="messageBox"></div>

            <div class="section-tabs">
                <button class="tab-btn active" onclick="showSection('gallery')">Gallery Management</button>
                <button class="tab-btn" onclick="showSection('location')">Location Management</button>
            </div>

            <!-- Upload Section -->
            <div id="gallery-section" class="upload-section">
                <h2 class="upload-title">Add New Installation Image</h2>
                <form id="uploadForm" class="upload-form">
                    <div class="form-column">
                        <div class="form-group">
                            <label for="imageTitle">Installation Title</label>
                            <input type="text" id="imageTitle" name="title" required placeholder="e.g., Corporate Office Complex">
                        </div>
                        
                        <div class="form-group">
                            <label for="imageLocation">Location/Info</label>
                            <input type="text" id="imageLocation" name="location" required placeholder="e.g., 50+ ABC Extinguishers Installed">
                        </div>
                        
                        <div class="form-group">
                            <label for="imageDescription">Description (Optional)</label>
                            <textarea id="imageDescription" name="description" rows="3" placeholder="Additional details about the installation..."></textarea>
                        </div>
                    </div>
                    
                    <div class="form-column">
                        <div class="form-group">
                            <label>Upload Image</label>
                            <div class="file-upload">
                                <input type="file" id="imageFile" name="image" accept="image/*" required>
                                <label for="imageFile" class="file-upload-label" id="fileUploadLabel">
                                    <div>
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                                        <p><strong>Click to upload</strong> or drag and drop</p>
                                        <p style="color: #666; font-size: 0.9rem;">PNG, JPG, GIF up to 10MB</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="upload-btn" id="uploadBtn">
                        <i class="fas fa-upload"></i> Upload Image
                    </button>
                </form>
            </div>

            <!-- Gallery Management -->
            <div class="gallery-management">
                <h2 class="upload-title">Manage Gallery Images</h2>
                <div class="gallery-grid" id="galleryGrid">
                    <!-- Gallery items will be loaded here -->
                </div>
            </div>
            
            <div id="location-section" class="upload-section" style="display: none;">
                <h2>Upload Location Image</h2>
                <form id="locationUploadForm" class="upload-form">
                    <div class="form-group">
                        <label for="locationImage">Location Image:</label>
                        <input type="file" id="locationImage" accept="image/*" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="locationTitle">Branch Name:</label>
                        <input type="text" id="locationTitle" placeholder="e.g., Main Branch" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="locationAddress">Address:</label>
                        <input type="text" id="locationAddress" placeholder="e.g., 123 Fire Safety Street, City Center" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="locationDescription">Description:</label>
                        <textarea id="locationDescription" placeholder="Brief description of this location" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="upload-btn">Upload Location</button>
                </form>
            </div>
            
            <div class="location-management" style="display: none;">
                <h2>Current Locations</h2>
                <div id="currentLocations" class="current-images">
                    <!-- Locations will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            if (!adminAuth.isLoggedIn()) {
                window.location.href = 'admin-login.html';
                return;
            }

            const uploadForm = document.getElementById('uploadForm');
            const uploadBtn = document.getElementById('uploadBtn');
            const messageBox = document.getElementById('messageBox');
            const galleryGrid = document.getElementById('galleryGrid');
            const fileUploadLabel = document.getElementById('fileUploadLabel');
            const imageFile = document.getElementById('imageFile');
            const logoutBtn = document.getElementById('logoutBtn');

            // Logout functionality
            logoutBtn.addEventListener('click', async function() {
                await adminAuth.logout();
                window.location.href = 'admin-login.html';
            });

            // File upload drag and drop
            fileUploadLabel.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            fileUploadLabel.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });

            fileUploadLabel.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    imageFile.files = files;
                    updateFileLabel(files[0]);
                }
            });

            imageFile.addEventListener('change', function() {
                if (this.files.length > 0) {
                    updateFileLabel(this.files[0]);
                }
            });

            function updateFileLabel(file) {
                fileUploadLabel.innerHTML = `
                    <div>
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: #27ae60; margin-bottom: 1rem;"></i>
                        <p><strong>${file.name}</strong></p>
                        <p style="color: #666; font-size: 0.9rem;">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                `;
            }

            // Upload form submission
            uploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const file = imageFile.files[0];
                const title = document.getElementById('imageTitle').value;
                const location = document.getElementById('imageLocation').value;
                const description = document.getElementById('imageDescription').value;
                
                if (!file) {
                    showMessage('Please select an image file.', 'error');
                    return;
                }
                
                // Show loading state
                uploadBtn.innerHTML = '<span class="loading"></span> Uploading...';
                uploadBtn.disabled = true;
                
                try {
                    // Generate unique filename
                    const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                    
                    // Upload image to Supabase
                    await galleryManager.uploadImage(file, fileName);
                    
                    // Get image URL
                    const imageUrl = galleryManager.getImageUrl(fileName);
                    
                    // Save metadata to database
                    await galleryManager.saveImageMetadata({
                        imageUrl: imageUrl,
                        title: title,
                        location: location,
                        description: description
                    });
                    
                    showMessage('Image uploaded successfully!', 'success');
                    uploadForm.reset();
                    resetFileLabel();
                    loadGalleryImages();
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    showMessage('Upload failed: ' + error.message, 'error');
                } finally {
                    uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Image';
                    uploadBtn.disabled = false;
                }
            });

            function resetFileLabel() {
                fileUploadLabel.innerHTML = `
                    <div>
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #e74c3c; margin-bottom: 1rem;"></i>
                        <p><strong>Click to upload</strong> or drag and drop</p>
                        <p style="color: #666; font-size: 0.9rem;">PNG, JPG, GIF up to 10MB</p>
                    </div>
                `;
            }

            function showMessage(text, type) {
                messageBox.textContent = text;
                messageBox.className = `message ${type}`;
                messageBox.style.display = 'block';
                
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 5000);
            }

            // Load and display gallery images
            async function loadGalleryImages() {
                try {
                    const images = await galleryManager.getAllImages();
                    displayGalleryImages(images);
                } catch (error) {
                    console.error('Error loading images:', error);
                    showMessage('Error loading gallery images.', 'error');
                }
            }

            function displayGalleryImages(images) {
                galleryGrid.innerHTML = '';
                
                if (images.length === 0) {
                    galleryGrid.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">No images uploaded yet.</p>';
                    return;
                }
                
                images.forEach(image => {
                    const imageElement = document.createElement('div');
                    imageElement.className = 'gallery-admin-item';
                    imageElement.innerHTML = `
                        <img src="${image.image_url}" alt="${image.title}" loading="lazy">
                        <div class="gallery-item-info">
                            <div class="gallery-item-title">${image.title}</div>
                            <div class="gallery-item-location">${image.location}</div>
                            <div class="gallery-item-description">${image.description || ''}</div>
                            <div class="gallery-item-actions">
                                <button class="edit-btn" onclick="editImage(${image.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="delete-btn" onclick="deleteImage(${image.id}, '${image.image_url.split('/').pop()}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                    galleryGrid.appendChild(imageElement);
                });
            }

            // Global functions for edit and delete
            window.editImage = function(imageId) {
                // Implement edit functionality
                showMessage('Edit functionality coming soon!', 'success');
            };

            window.deleteImage = async function(imageId, fileName) {
                if (confirm('Are you sure you want to delete this image?')) {
                    try {
                        await galleryManager.deleteImage(imageId, fileName);
                        showMessage('Image deleted successfully!', 'success');
                        loadGalleryImages();
                    } catch (error) {
                        console.error('Delete error:', error);
                        showMessage('Error deleting image: ' + error.message, 'error');
                    }
                }
            };

            // Load gallery images on page load
            loadGalleryImages();
        });

        // Tab switching functionality
        function showSection(section) {
            // Hide all sections
            document.getElementById('gallery-section').style.display = 'none';
            document.getElementById('location-section').style.display = 'none';
            document.querySelector('.gallery-management').style.display = 'none';
            document.querySelector('.location-management').style.display = 'none';
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            if (section === 'gallery') {
                document.getElementById('gallery-section').style.display = 'block';
                document.querySelector('.gallery-management').style.display = 'block';
                document.querySelector('.tab-btn').classList.add('active');
            } else if (section === 'location') {
                document.getElementById('location-section').style.display = 'block';
                document.querySelector('.location-management').style.display = 'block';
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
            }
        }
        
        // Location upload form handler
        document.getElementById('locationUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('locationImage');
            const title = document.getElementById('locationTitle').value;
            const address = document.getElementById('locationAddress').value;
            const description = document.getElementById('locationDescription').value;
            
            if (!fileInput.files[0]) {
                showMessage('Please select an image file', 'error');
                return;
            }
            
            try {
                showMessage('Uploading location...', 'info');
                
                const result = await locationManager.uploadLocation(
                    fileInput.files[0],
                    title,
                    address,
                    description
                );
                
                if (result.success) {
                    showMessage('Location uploaded successfully!', 'success');
                    document.getElementById('locationUploadForm').reset();
                    loadCurrentLocations();
                } else {
                    showMessage('Upload failed: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('Upload failed: ' + error.message, 'error');
            }
        });
        
        // Load current locations
        async function loadCurrentLocations() {
            try {
                const locations = await locationManager.getAllLocations();
                const container = document.getElementById('currentLocations');
                
                if (locations && locations.length > 0) {
                    container.innerHTML = locations.map(location => `
                        <div class="image-item">
                            <img src="${location.image_url}" alt="${location.title}">
                            <div class="image-info">
                                <h4>${location.title}</h4>
                                <p>${location.address}</p>
                                <button onclick="deleteLocation('${location.id}')" class="delete-btn">Delete</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p>No locations uploaded yet.</p>';
                }
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }
        
        // Delete location
        async function deleteLocation(locationId) {
            if (confirm('Are you sure you want to delete this location?')) {
                try {
                    const result = await locationManager.deleteLocation(locationId);
                    if (result.success) {
                        showMessage('Location deleted successfully!', 'success');
                        loadCurrentLocations();
                    } else {
                        showMessage('Delete failed: ' + result.error, 'error');
                    }
                } catch (error) {
                    showMessage('Delete failed: ' + error.message, 'error');
                }
            }
        }
    </script>
</body>
</html>